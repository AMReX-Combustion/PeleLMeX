# ECP KPP challenge problem

This case is the ECP challenge problem, looking into the auto-ignition behavior of
a dual-fuel pulse into a representative piston-bowl geometry, in  realistic conditions.
The chamber is initially filled with a mixture of methane and air resulting from a
first port injection. Then injection of a diesel surrogate, n-dodecane, is triggered
and the simulation focuses on the ignition at the vicinity of these fuel jets.

## Geometry

The geometry is that of a simplified piston-bowl, scaled down by a factor 4. The scaled
cylinder is 24 mm in diameter and the piston head is generated by rotating a spline around
the cylinder axis, resulting in a top volume 2.29 mm in height and extending in the piston
head by 3.92 mm. The geometry is generated within the EBUserDefined.H file.

## Chamber initial conditions

The initial conditions in the chamber are controlled by the following parameters (SI units):
```
  prob.P_mean        = 6079500.0
  prob.T_mean        = 900.0
  prob.Y_CH4_chamber = 0.020594
  prob.Y_O2_chamber  = 0.164305
```
with the remainder of the mixture made up of nitrogen. These default conditions correspond to a lean
mixture of CH4 in viciated air at an equivalence ratio of 0.5.

Velocity in the chamber is initialized from a precursor HIT simulation. Data are stored in a binary
fine and interpolated onto the AMReX grid. A set of parameter control the position as well as the
scaling of this velocity field and it is advised not to modify those parameters:

```
ic.hitIC = 1
ic.input_resolution = 128
ic.input_binaryformat = 1
ic.input_name = "hit_ic_ut_128.in"
ic.uin_norm = 1.3231790983814187
ic.lscale = 241.66097335 # = 2*pi / domain length
ic.offset = -3.1415926536
ic.urms0 = 4.0
ic.win_lo = -0.007 -0.007 0.0015
ic.win_hi =  0.007  0.007 0.003
ic.win_slope = 1000.0
```

One can remove this initial velocity field by switching of the `ic.hitIC` key.

## Diesel injection

The second fuel is injected directly into the chamber and diesel is represented by a single component
surrogate: n-dodecane. The injection is controlled by the following parameters:

```
  prob.nholes             = 4
  prob.centx              = 0.0
  prob.centy              = 0.0
  prob.r_circ             = 0.0015
  prob.r_hole             = 0.000085
  prob.cone_angle         = 45.0
  prob.T_jet              = 470.0
  prob.vel_jet            = 28.0
  prob.Z                  = 0.45
  prob.injection_start    = 0.0
  prob.injection_duration = 0.0005
```

The injection plane is located on the z^+^ *xy*-plane, located ~10 mm downstream of the actual diesel nozzle.
It is assumed that the liquid jet is fully evaporated and partially mixed with entrained surrounded mixture.
This jet mixture composition is controlled by the *Z* parameters, defaulted to 45% of n-dodecane and 55% of
the initial chamber mixture.
The center of the injector is specified by *centx* and *centy*, with (0.0;0.0) being the center of the
computational domain and the cylinder. On the z^+^ *xy*-plane, the jets of radius *r_hole* are distributed
on a circle of radius *r_circ*, obtained by geometrically extruding from the diesel injector to the injection
plane with the jet angle specified by *cone_angle* (measured between the cylinder axis and the jet axis).
The temperature and velocity of the jet, as well as the number of jets are controlled by *T_jet*, *vel_jet* and
*nholes*, respectively.
Finally, the timing and duration of the injector can be controlled.

On top of the mean jet velocity specified, velocity fluctuations from a precursor, fully developed turbulent pipe
simulation are provided using the following section of the input file (one inj* block per jet):

```
turbinflows= inj1 inj2 inj3 inj4

turbinflow.inj1.turb_file      = Turb.test2
turbinflow.inj1.dir            = 2
turbinflow.inj1.side           = high
turbinflow.inj1.turb_scale_loc = 1.0
turbinflow.inj1.turb_scale_vel = 1.0
turbinflow.inj1.turb_center    = 0.0 0.0015
turbinflow.inj1.turb_conv_vel  = 28.0
turbinflow.inj1.turb_nplane    = 32
turbinflow.inj1.time_offset    = 0.0
```

Note that data from a single precursor simulation is used for all four jets, but the data is offsetted in time to
desynchronize the jets.

## Refinement

The placement of AMR levels is finely tune to ensure an efficient use of the available resources.
At the beginning of the simulation, fixed refinement is added near the jet injection to ensure
sufficient resolution of the jet turbulence. Subsequently, refinement based on temperature is used
to focus on the comparatively cold jets (*T* < 850 K) and any onset of ignition (*T* > 925 K).
Additionally, the EB is initially kept at the base level and the following set of parameters
ensure that AMR patches do not cross the EB:

```
peleLM.refine_EB_type = Static
peleLM.refine_EB_max_level = 0
peleLM.refine_EB_buffer = 2.2
```

At later time (*t* > 0.6 ms), this constraint can be relaxed to enable refienement close to the EB
as the jets develop (increasing *refine\_EB\_max\_level* to 1 or higher).
Finally, note that even though the *amr.max\_level* is set to 5 from the start of the simulation,
AMR refinement criterion are only trigger up to level 3 (at least initially). This enable keeping
a fixed EB representation as the refinement criterion are extended to higher level later in the
simulation.

## Running the KPP problem

To run this problem, the nodal projection needs to be performed with the Hypre library because the
EB geometry leads to linear system condition numbers that AMReX GMG is not able to handle.
In particular, one needs the preconditioning strategy recently developed by S. Thomas (https://arxiv.org/abs/2111.09512)
and currently implemented in the `IterTriSolve` branch of:

https://github.com/sthomas61/hypre.git

Once Hypre been compiled, one can turn on the use of Hypre in AMReX (USE_HYPRE=TRUE) and the provide the path to
the library using HYPRE_HOME in the GNUmakefile.

The turbulent jet boundary condition is read in from a precursor simulation stored into a 'TurbFile'. A single file is
employed for all 4 jets, with a time offset allowing each jet to read in turbulent data shifted in time. The `TurbFile`
used for the KPP can be found on ORNL's Summit on the following location (shared CMB138 project directory):

/gpfs/alpine/proj-shared/cmb138/ECP_KPP/Turb.test2

Similarly, the initial velocity condition is generated from an HIT simulation. The HIT data are stored in a file
that can be obtained in the same location:

/gpfs/alpine/proj-shared/cmb138/ECP_KPP/hit_ic_ut_128.in

On Crusher, please load the following modules:

module load PrgEnv-amd rocm/5.1.0 craype-accel-amd-gfx90a cray-libsci/21.08.1.2

On Summit, please load the following ones:

module load cmake gcc cuda netlib-lapack
