<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PeleLMeX controls &mdash; PeleLMeX 22.12 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/theme.css?v=df66b05f" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=d09052ea"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Troubleshooting" href="Troubleshooting.html" />
    <link rel="prev" title="Performances" href="Performances.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            PeleLMeX
              <img src="_static/swirlH2Fast_OH_vort_256.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Theory:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Model.html">The <cite>PeleLMeX</cite> Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Implementation.html">Source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="Validation.html">PeleLMeX Verification &amp; Validations</a></li>
<li class="toctree-l1"><a class="reference internal" href="Performances.html">Performances</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">PeleLMeX controls</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#computational-domain-definition">Computational domain definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#grid-amr-parameters">Grid/AMR parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-balancing">Load balancing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#time-stepping-parameters">Time stepping parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#io-parameters">IO parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#refinement-controls">Refinement controls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pelelmex-derived-variables">PeleLMeX derived variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pelelmex-algorithm">PeleLMeX algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transport-coeffs-and-les">Transport coeffs and LES</a></li>
<li class="toctree-l2"><a class="reference internal" href="#chemistry-integrator">Chemistry integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#embedded-geometry">Embedded Geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#linear-solvers">Linear solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#active-control">Active control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-time-diagnostics">Run-time diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-time-control">Run-time control</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Tutorials.html">Tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PeleLMeX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">PeleLMeX controls</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/LMeXControls.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pelelmex-controls">
<h1>PeleLMeX controls<a class="headerlink" href="#pelelmex-controls" title="Link to this heading"></a></h1>
<p id="sec-control">The input file specified on the command line is a free-format text file, one entry per row, that specifies input data processed by the AMReX <code class="docutils literal notranslate"><span class="pre">ParmParse</span></code> module.
This file needs to specified along with the executable as an <cite>argv</cite> option, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">64</span> <span class="o">./</span><span class="n">PeleLMeX2d</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">ex</span> <span class="n">inputs</span>
</pre></div>
</div>
<p>Also, any entry that can be specified in the inputs file can also be specified on the command line; values specified on the command line override values in the inputs file, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">64</span> <span class="o">./</span><span class="n">PeleLMeX2d</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">ex</span> <span class="n">inputs</span> <span class="n">amr</span><span class="o">.</span><span class="n">max_level</span><span class="o">=</span><span class="mi">2</span>
</pre></div>
</div>
<p>The available options are divided into groups: those that control primarily AMReX are prefaced with <cite>amr.</cite>, those that are specific to the PeleLMeX are prefaced by <cite>peleLM.</cite>, while those corresponding to the various pieces of the algorithm are prefaced with specific keys, such that <cite>diffusion</cite>, <cite>nodal_proj</cite>, … as described below.</p>
<section id="computational-domain-definition">
<h2>Computational domain definition<a class="headerlink" href="#computational-domain-definition" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#--------------------GEOMETRY DEFINITION-----------------------</span>
<span class="n">geometry</span><span class="o">.</span><span class="n">is_periodic</span> <span class="o">=</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span>              <span class="c1"># For each dir, 0: non-perio, 1: periodic</span>
<span class="n">geometry</span><span class="o">.</span><span class="n">coord_sys</span>   <span class="o">=</span> <span class="mi">0</span>                  <span class="c1"># 0 =&gt; cart, 1 =&gt; RZ</span>
<span class="n">geometry</span><span class="o">.</span><span class="n">prob_lo</span>     <span class="o">=</span> <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>    <span class="c1"># x_lo y_lo (z_lo)</span>
<span class="n">geometry</span><span class="o">.</span><span class="n">prob_hi</span>     <span class="o">=</span> <span class="mf">0.016</span> <span class="mf">0.016</span> <span class="mf">0.032</span>  <span class="c1"># x_hi y_hi (z_hi)</span>

<span class="c1">#-----------------------BNDY CONDITIONS------------------------</span>
<span class="c1"># Interior, Inflow, Outflow, Symmetry, SlipWallAdiab, NoSlipWallAdiab</span>
<span class="c1"># SlipWallIsotherm, NoSlipWallIsotherm</span>
<span class="c1"># Periodic direction must be set as Interior</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">lo_bc</span> <span class="o">=</span> <span class="n">Interior</span> <span class="n">Interior</span> <span class="n">Inflow</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">hi_bc</span> <span class="o">=</span> <span class="n">Interior</span> <span class="n">Interior</span> <span class="n">Inflow</span>
</pre></div>
</div>
</section>
<section id="grid-amr-parameters">
<h2>Grid/AMR parameters<a class="headerlink" href="#grid-amr-parameters" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#-------------------------AMR CONTROL--------------------------</span>
<span class="n">amr</span><span class="o">.</span><span class="n">n_cell</span>          <span class="o">=</span> <span class="mi">64</span> <span class="mi">64</span> <span class="mi">128</span>        <span class="c1"># Number of cells on Level 0 in each direction</span>
<span class="n">amr</span><span class="o">.</span><span class="n">v</span>               <span class="o">=</span> <span class="mi">1</span>                <span class="c1"># [OPT, DEF=0] AMR verbose</span>
<span class="n">amr</span><span class="o">.</span><span class="n">max_level</span>       <span class="o">=</span> <span class="mi">1</span>                <span class="c1"># maximum level number allowed</span>
<span class="n">amr</span><span class="o">.</span><span class="n">ref_ratio</span>       <span class="o">=</span> <span class="mi">2</span> <span class="mi">2</span> <span class="mi">2</span> <span class="mi">2</span>          <span class="c1"># refinement ratio, one per refinement level</span>
<span class="n">amr</span><span class="o">.</span><span class="n">regrid_int</span>      <span class="o">=</span> <span class="mi">5</span>                <span class="c1"># how often to regrid</span>
<span class="n">amr</span><span class="o">.</span><span class="n">n_error_buf</span>     <span class="o">=</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span>          <span class="c1"># number of buffer cells in error est, one per refinement level</span>
<span class="n">amr</span><span class="o">.</span><span class="n">grid_eff</span>        <span class="o">=</span> <span class="mf">0.7</span>              <span class="c1"># what constitutes an efficient grid</span>
<span class="n">amr</span><span class="o">.</span><span class="n">blocking_factor</span> <span class="o">=</span> <span class="mi">16</span>               <span class="c1"># block factor in grid generation (min box size)</span>
<span class="n">amr</span><span class="o">.</span><span class="n">max_grid_size</span>   <span class="o">=</span> <span class="mi">64</span>               <span class="c1"># max box size</span>

<span class="n">peleLM</span><span class="o">.</span><span class="n">max_grid_size_chem</span> <span class="o">=</span> <span class="mi">32</span>         <span class="c1"># [OPT, DEF=&quot;None&quot;] Max box size for the Chemistry BoxArray</span>
</pre></div>
</div>
</section>
<section id="load-balancing">
<h2>Load balancing<a class="headerlink" href="#load-balancing" title="Link to this heading"></a></h2>
<p><em>PeleLMeX</em> relies on two distribution maps (see <a class="reference internal" href="Implementation.html"><span class="doc">Source code</span></a> for more details).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peleLM</span><span class="o">.</span><span class="n">do_load_balancing</span> <span class="o">=</span> <span class="mi">1</span>                    <span class="c1"># [OPT, DEF=0] Activate load balancing</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">load_balancing_method</span> <span class="o">=</span> <span class="n">sfc</span>              <span class="c1"># [OPT, DEF=&quot;sfc&quot;] AmrCore dmap load balancing method</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">load_balancing_cost_estimate</span> <span class="o">=</span> <span class="n">ncell</span>     <span class="c1"># [OPT, DEF=&quot;ncell&quot;] AmrCore dmap balancing cost</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">chem_load_balancing_method</span> <span class="o">=</span> <span class="n">knapsack</span>    <span class="c1"># [OPT, DEF=&quot;knapsack&quot;] Chemistry dmap load balancing method</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">chem_load_balancing_cost_estimate</span> <span class="o">=</span> <span class="n">chemfunctcall_sum</span> <span class="c1"># [OPT, DEF=&quot;chemfunctcall_sum&quot;] Chemistry dmap balancing cost</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">load_balancing_efficiency_threshold</span> <span class="o">=</span> <span class="mf">1.05</span>  <span class="c1"># What constitute a better dmap ?</span>
</pre></div>
</div>
<p>The balancing method can be one of <cite>sfc</cite>, <cite>roundrobin</cite> or <cite>knapsack</cite>, while the cost estimate can be one of
<cite>ncell</cite>, <cite>chemfunctcall_avg</cite>, <cite>chemfunctcall_max</cite>, <cite>chemfunctcall_sum</cite>, <cite>userdefined_avg</cite> or <cite>userdefined_sum</cite>. When
using either of the last to option, the user must provide a definition for the <cite>derUserDefined</cite>. If multiple components
are defined in the <cite>derUserDefined</cite> function, the first one is used for load balancing.</p>
</section>
<section id="time-stepping-parameters">
<h2>Time stepping parameters<a class="headerlink" href="#time-stepping-parameters" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#-------------------------TIME STEPPING------------------------</span>
<span class="n">amr</span><span class="o">.</span><span class="n">max_step</span>      <span class="o">=</span> <span class="mi">20</span>                 <span class="c1"># Maximum number of steps</span>
<span class="n">amr</span><span class="o">.</span><span class="n">stop_time</span>     <span class="o">=</span> <span class="mf">0.001</span>              <span class="c1"># Maximum simulation time [s]</span>
<span class="n">amr</span><span class="o">.</span><span class="n">max_wall_time</span> <span class="o">=</span> <span class="mf">1.0</span>                <span class="c1"># Maximum wall clock time [hr]</span>
<span class="n">amr</span><span class="o">.</span><span class="n">cfl</span>           <span class="o">=</span> <span class="mf">0.5</span>                <span class="c1"># [OPT, DEF=0.7] CFL for advection-controlled dt estimate</span>
<span class="n">amr</span><span class="o">.</span><span class="n">fixed_dt</span>      <span class="o">=</span> <span class="mf">1e-6</span>               <span class="c1"># [OPT] optional fixed dt (override CFL condition)</span>
<span class="n">amr</span><span class="o">.</span><span class="n">min_dt</span>        <span class="o">=</span> <span class="mf">1e-11</span>              <span class="c1"># [OPT, DEF=1e-12] small time step size limit triggering simulation termination</span>
<span class="n">amr</span><span class="o">.</span><span class="n">init_dt</span>       <span class="o">=</span> <span class="mf">1e-6</span>               <span class="c1"># [OPT] optional initial dt (override CFL condition upon initialization)</span>
<span class="n">amr</span><span class="o">.</span><span class="n">dt_shrink</span>     <span class="o">=</span> <span class="mf">0.0001</span>             <span class="c1"># [OPT, DEF=1.0] dt factor upon initialization</span>
<span class="n">amr</span><span class="o">.</span><span class="n">dt_change_max</span> <span class="o">=</span> <span class="mf">1.1</span>                <span class="c1"># [OPT, DEF=1.1] maximum dt change between consecutive steps</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that one of <cite>amr.max_step</cite>, <cite>amr.stop_time</cite>, or <cite>amr.max_wall_time</cite> is required, and if more than one is specified,
the first stopping criterion encountered will lead to termination of the simulation.</p>
</div>
</section>
<section id="io-parameters">
<h2>IO parameters<a class="headerlink" href="#io-parameters" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#--------------------------IO CONTROL--------------------------</span>
<span class="n">amr</span><span class="o">.</span><span class="n">plot_int</span>         <span class="o">=</span> <span class="mi">20</span>              <span class="c1"># [OPT, DEF=-1] Frequency (as step #) for writing plot file</span>
<span class="n">amr</span><span class="o">.</span><span class="n">plot_per</span>         <span class="o">=</span> <span class="mf">0.002</span>           <span class="c1"># [OPT, DEF=-1] Period (time in s) for writing plot file</span>
<span class="n">amr</span><span class="o">.</span><span class="n">plot_per_exact</span>   <span class="o">=</span> <span class="mi">1</span>               <span class="c1"># [OPT, DEF=0] Flag to enforce exactly plt_per by shortening dt</span>
<span class="n">amr</span><span class="o">.</span><span class="n">plot_file</span>        <span class="o">=</span> <span class="s2">&quot;plt_&quot;</span>          <span class="c1"># [OPT, DEF=&quot;plt_&quot;] Plot file prefix</span>
<span class="n">amr</span><span class="o">.</span><span class="n">check_int</span>        <span class="o">=</span> <span class="mi">100</span>             <span class="c1"># [OPT, DEF=-1] Frequency (as step #) for writing checkpoint file</span>
<span class="n">amr</span><span class="o">.</span><span class="n">check_per</span>        <span class="o">=</span> <span class="mf">0.05</span>            <span class="c1"># [OPT, DEF=-1] Period (time in s) for writing checkpoint file</span>
<span class="n">amr</span><span class="o">.</span><span class="n">check_file</span>       <span class="o">=</span> <span class="s2">&quot;chk&quot;</span>           <span class="c1"># [OPT, DEF=&quot;chk&quot;] Checkpoint file prefix</span>
<span class="n">amr</span><span class="o">.</span><span class="n">file_stepDigits</span>  <span class="o">=</span> <span class="mi">6</span>               <span class="c1"># [OPT, DEF=5] Number of digits when adding nsteps to plt and chk names</span>
<span class="n">amr</span><span class="o">.</span><span class="n">derive_plot_vars</span> <span class="o">=</span> <span class="n">avg_pressure</span> <span class="o">...</span><span class="c1"># [OPT, DEF=&quot;&quot;] List of derived variable included in the plot files</span>
<span class="n">amr</span><span class="o">.</span><span class="n">plot_speciesState</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># [OPT, DEF=0] Force adding state rhoYs to the plot files</span>

<span class="n">amr</span><span class="o">.</span><span class="n">restart</span>          <span class="o">=</span> <span class="n">chk00100</span>        <span class="c1"># [OPT, DEF=&quot;&quot;] Checkpoint from which to restart the simulation</span>
<span class="n">amr</span><span class="o">.</span><span class="n">initDataPlt</span>      <span class="o">=</span> <span class="n">plt01000</span>        <span class="c1"># [OPT, DEF=&quot;&quot;] Provide a plotfile from which to extract initial data</span>
<span class="n">amr</span><span class="o">.</span><span class="n">regrid_on_restart</span> <span class="o">=</span> <span class="mi">1</span>              <span class="c1"># [OPT, DEF=&quot;0&quot;] Trigger a regrid after the data from checkpoint are loaded</span>
</pre></div>
</div>
</section>
<section id="refinement-controls">
<h2>Refinement controls<a class="headerlink" href="#refinement-controls" title="Link to this heading"></a></h2>
<p>Refinement in PeleLMeX is controlled by a set of ‘Tagging’ criterion listed under the <cite>amr.refinement_indicators</cite>
key. For each criteriq, the user needs to supply a definition. For example, the following provides a complete
overview of the available controls:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">amr</span><span class="o">.</span><span class="n">refinement_indicators</span> <span class="n">gthan</span> <span class="n">lthan</span> <span class="n">adjd</span> <span class="n">box1</span>

<span class="n">amr</span><span class="o">.</span><span class="n">gthan</span><span class="o">.</span><span class="n">max_level</span>     <span class="o">=</span> <span class="mi">3</span>
<span class="n">amr</span><span class="o">.</span><span class="n">gthan</span><span class="o">.</span><span class="n">value_greater</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">amr</span><span class="o">.</span><span class="n">gthan</span><span class="o">.</span><span class="n">field_name</span>    <span class="o">=</span> <span class="n">x_velocity</span>

<span class="n">amr</span><span class="o">.</span><span class="n">lthan</span><span class="o">.</span><span class="n">max_level</span>     <span class="o">=</span> <span class="mi">4</span>
<span class="n">amr</span><span class="o">.</span><span class="n">lthan</span><span class="o">.</span><span class="n">value_less</span>    <span class="o">=</span> <span class="mf">400.0</span>
<span class="n">amr</span><span class="o">.</span><span class="n">lthan</span><span class="o">.</span><span class="n">field_name</span>    <span class="o">=</span> <span class="n">temp</span>
<span class="n">amr</span><span class="o">.</span><span class="n">lthan</span><span class="o">.</span><span class="n">start_time</span>    <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">amr</span><span class="o">.</span><span class="n">lthan</span><span class="o">.</span><span class="n">end_time</span>      <span class="o">=</span> <span class="mf">0.005</span>

<span class="n">amr</span><span class="o">.</span><span class="n">adjd</span><span class="o">.</span><span class="n">max_level</span>                   <span class="o">=</span> <span class="mi">2</span>
<span class="n">amr</span><span class="o">.</span><span class="n">adjd</span><span class="o">.</span><span class="n">adjacent_difference_greater</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">amr</span><span class="o">.</span><span class="n">adjd</span><span class="o">.</span><span class="n">field_name</span>                  <span class="o">=</span> <span class="n">density</span>

<span class="n">amr</span><span class="o">.</span><span class="n">box1</span><span class="o">.</span><span class="n">max_level</span>      <span class="o">=</span> <span class="mi">1</span>
<span class="n">amr</span><span class="o">.</span><span class="n">box1</span><span class="o">.</span><span class="n">in_box_lo</span>      <span class="o">=</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">amr</span><span class="o">.</span><span class="n">box1</span><span class="o">.</span><span class="n">in_box_hi</span>      <span class="o">=</span> <span class="mf">0.01</span> <span class="mf">0.01</span> <span class="mf">0.05</span>
</pre></div>
</div>
<p>The <cite>field_name</cite> can be any of the state or derived variables (see below) component. Additional controls specific
to embedded boundaries are discussed below.</p>
</section>
<section id="pelelmex-derived-variables">
<h2>PeleLMeX derived variables<a class="headerlink" href="#pelelmex-derived-variables" title="Link to this heading"></a></h2>
<p>The following list of derived variables are available in PeleLMeX:</p>
<table class="docutils align-default" id="id1">
<caption><span class="caption-number">Table 7 </span><span class="caption-text">PeleLMeX derived variables</span><a class="headerlink" href="#id1" title="Link to this table"></a></caption>
<colgroup>
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 66.7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Size (nComp)</p></th>
<th class="head"><p>Brief</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>mass_fractions</cite></p></td>
<td><p>NUM_SPECIES</p></td>
<td><p>Species mass fractions</p></td>
</tr>
<tr class="row-odd"><td><p><cite>mole_fractions</cite></p></td>
<td><p>NUM_SPECIES</p></td>
<td><p>Species mole fractions</p></td>
</tr>
<tr class="row-even"><td><p><cite>diffcoeff</cite></p></td>
<td><p>NUM_SPECIES</p></td>
<td><p>Species mixture-averaged diffusion coefficients</p></td>
</tr>
<tr class="row-odd"><td><p><cite>lambda</cite></p></td>
<td><p>1</p></td>
<td><p>Thermal diffusivity</p></td>
</tr>
<tr class="row-even"><td><p><cite>viscosity</cite></p></td>
<td><p>1</p></td>
<td><p>Mixture viscosity</p></td>
</tr>
<tr class="row-odd"><td><p><cite>mixture_fraction</cite></p></td>
<td><p>1</p></td>
<td><p>Mixture fraction based on Bilger’s element formulation</p></td>
</tr>
<tr class="row-even"><td><p><cite>progress_variable</cite></p></td>
<td><p>1</p></td>
<td><p>Progress variable based on a linear combination of Ys, T</p></td>
</tr>
<tr class="row-odd"><td><p><cite>avg_pressure</cite></p></td>
<td><p>1</p></td>
<td><p>Cell-averaged pressure (from the node-centered pressure)</p></td>
</tr>
<tr class="row-even"><td><p><cite>mag_vort</cite></p></td>
<td><p>1</p></td>
<td><p>Vorticity magnitude</p></td>
</tr>
<tr class="row-odd"><td><p><cite>vorticity</cite></p></td>
<td><p>AMREX_SPACEDIM*2-3</p></td>
<td><p>VortZ (2D) or VortX, VortY, VortZ (3D)</p></td>
</tr>
<tr class="row-even"><td><p><cite>Qcrit</cite></p></td>
<td><p>1</p></td>
<td><p>Q-Criterion : <span class="math notranslate nohighlight">\(0.5(|\boldsymbol{\Omega}|^2 - |\boldsymbol{S}|^2)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><cite>kinetic_energy</cite></p></td>
<td><p>1</p></td>
<td><p>Kinetic energy: 0.5 * rho * (u^2+v^2+w^2)</p></td>
</tr>
<tr class="row-even"><td><p><cite>enstrophy</cite></p></td>
<td><p>1</p></td>
<td><p>enstrophy: 0.5 * rho * (omega_x^2+omega_y^2+omega_z^2)</p></td>
</tr>
<tr class="row-odd"><td><p><cite>HeatRelease</cite></p></td>
<td><p>1</p></td>
<td><p>Heat release rate from chem. reactions</p></td>
</tr>
<tr class="row-even"><td><p><cite>rhominsumrhoY</cite></p></td>
<td><p>1</p></td>
<td><p>Rho minus sum of rhoYs, for debug purposes</p></td>
</tr>
<tr class="row-odd"><td><p><cite>coordinates</cite></p></td>
<td><p>AMREX_SPACEDIM</p></td>
<td><p>Cell-center coordinates</p></td>
</tr>
<tr class="row-even"><td><p><cite>DistributionMap</cite></p></td>
<td><p>1</p></td>
<td><p>The MPI-rank of each box</p></td>
</tr>
<tr class="row-odd"><td><p><cite>derUserDefined</cite></p></td>
<td><p>?</p></td>
<td><p>A user-defined derived which number of components is provided by the user (see below).</p></td>
</tr>
</tbody>
</table>
<p>Note that <cite>mixture_fraction</cite> and <cite>progress_variable</cite> requires additional inputs from the users as described below.
The <cite>derUserDefined</cite> allow the user to define its own derived variable which can comprise several components. To do
so, the user need to copy the Source/DeriveUserDefined.cpp file into his run folder and update the file. The number of
components is defined based on the size of the vector returned by pelelmex_setuserderives().</p>
</section>
<section id="pelelmex-algorithm">
<h2>PeleLMeX algorithm<a class="headerlink" href="#pelelmex-algorithm" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#-----------------------PELE CONTROL-----------------------</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="mi">1</span>                           <span class="c1"># [OPT, DEF=0] Verbose</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="n">normal</span>               <span class="c1"># [OPT, DEF=normal] Switch between time-advance mode (normal) or UnitTest (evaluate)</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">use_wbar</span> <span class="o">=</span> <span class="mi">1</span>                    <span class="c1"># [OPT, DEF=1] Enable Wbar correction in diffusion fluxes</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">sdc_iterMax</span> <span class="o">=</span> <span class="mi">2</span>                 <span class="c1"># [OPT, DEF=1] Number of SDC iterations</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">num_init_iter</span> <span class="o">=</span> <span class="mi">2</span>               <span class="c1"># [OPT, DEF=3] Number of iterations to get initial pressure</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">num_divu_iter</span> <span class="o">=</span> <span class="mi">1</span>               <span class="c1"># [OPT, DEF=1] Number of divU iterations to get initial dt estimate</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">do_init_proj</span> <span class="o">=</span> <span class="mi">1</span>                <span class="c1"># [OPT, DEF=1] Control over initial projection</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">advection_scheme</span> <span class="o">=</span> <span class="n">Godunov_BDS</span>  <span class="c1"># [OPT, DEF=Godunov_PLM] Advection scheme: Godunov_PLM, Godunov_PPM or Godunov_BDS</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">incompressible</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># [OPT, DEF=0] Enable to run fully incompressible, scalar advance is bypassed</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">m_rho</span> <span class="o">=</span> <span class="mf">1.17</span>                    <span class="c1"># [OPT, DEF=-1] If incompressible, density value [MKS]</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">m_mu</span> <span class="o">=</span> <span class="mf">1.8e-5</span>                   <span class="c1"># [OPT, DEF=-1] If incompressible, kinematic visc. value [MKS]</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">gravity</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="o">-</span><span class="mf">9.81</span>         <span class="c1"># [OPT, DEF=Vec{0.0}] Gravity vector [MKS]</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">gradP0</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">10.0</span>           <span class="c1"># [OPT, DEF=Vec{0.0}] Average background pressure gradient [Pa/m]</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">closed_chamber</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># [OPT] Override the automatic detection of closed chamber (based on Outflow(s))</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">floor_species</span> <span class="o">=</span> <span class="mi">0</span>               <span class="c1"># [OPT, DEF=0] Crudely enforce mass fraction positivity</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">deltaT_verbose</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># [OPT, DEF=0] Verbose of the deltaT iterative solve algorithm</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">deltaT_iterMax</span> <span class="o">=</span> <span class="mi">5</span>              <span class="c1"># [OPT, DEF=10] Maximum number of deltaT iterations</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">deltaT_tol</span> <span class="o">=</span> <span class="mf">1e-10</span>              <span class="c1"># [OPT, DEF=1.e-10] Tolerance of the deltaT solve</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">evaluate_vars</span> <span class="o">=...</span>              <span class="c1"># [OPT, DEF=&quot;&quot;] In evaluate mode, list unitTest: diffTerm, divU, instRR, transportCC</span>
</pre></div>
</div>
</section>
<section id="transport-coeffs-and-les">
<h2>Transport coeffs and LES<a class="headerlink" href="#transport-coeffs-and-les" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#-----------------------DIFFUSION AND LES MODEL CONTROL-----------------------</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">unity_Le</span> <span class="o">=</span> <span class="mi">0</span>                    <span class="c1"># [OPT, DEF=0] Use the unity Lewis number approximation for diffusivities</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">Prandtl</span> <span class="o">=</span> <span class="mf">0.7</span>                   <span class="c1"># [OPT, DEF=0.7] If unity_Le or doing LES, specifies the Prandtl number</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">les_model</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>              <span class="c1"># [OPT, DEF=&quot;None&quot;] Model to compute turbulent viscosity: None, Smagorinsky, WALE, Sigma</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">les_cs_smag</span> <span class="o">=</span> <span class="mf">0.18</span>              <span class="c1"># [OPT, DEF=0.18] If using Smagorinsky LES model, provides model coefficient</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">les_cm_wale</span> <span class="o">=</span> <span class="mf">0.60</span>              <span class="c1"># [OPT, DEF=0.60] If using WALE LES model, provides model coefficient</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">les_cs_sigma</span> <span class="o">=</span> <span class="mf">1.35</span>             <span class="c1"># [OPT, DEF=1.35] If using Sigma LES model, provides model coefficient</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">les_v</span> <span class="o">=</span> <span class="mi">0</span>                       <span class="c1"># [OPT, DEF=0] Verbosity level for LES model</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">plot_les</span> <span class="o">=</span> <span class="mi">0</span>                    <span class="c1"># [OPT, DEF=0] If doing LES, whether to plot the turbulent viscosity</span>
</pre></div>
</div>
</section>
<section id="chemistry-integrator">
<h2>Chemistry integrator<a class="headerlink" href="#chemistry-integrator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#-----------------------CHEMISTRY CONTROL----------------------</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">chem_integrator</span>   <span class="o">=</span> <span class="s2">&quot;ReactorCvode&quot;</span>   <span class="c1"># Chemistry integrator, from PelePhysics available list</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">use_typ_vals_chem</span> <span class="o">=</span> <span class="mi">1</span>                <span class="c1"># [OPT, DEF=1] Use Typical values to scale components in the reactors</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">typical_values_reset_int</span> <span class="o">=</span> <span class="mi">5</span>         <span class="c1"># [OPT, DEF=10] Frequency at which the typical values are updated</span>
<span class="n">ode</span><span class="o">.</span><span class="n">rtol</span> <span class="o">=</span> <span class="mf">1.0e-6</span>                           <span class="c1"># [OPT, DEF=1e-10] Relative tolerance of the chem. reactor</span>
<span class="n">ode</span><span class="o">.</span><span class="n">atol</span> <span class="o">=</span> <span class="mf">1.0e-6</span>                           <span class="c1"># [OPT, DEF=1e-10] Absolute tolerance of the chem. reactor, or pre-factor of the typical values when used</span>
<span class="n">cvode</span><span class="o">.</span><span class="n">solve_type</span> <span class="o">=</span> <span class="n">denseAJ_direct</span>           <span class="c1"># [OPT, DEF=GMRES] Linear solver employed for CVODE Newton direction</span>
<span class="n">cvode</span><span class="o">.</span><span class="n">max_order</span>  <span class="o">=</span> <span class="mi">4</span>                        <span class="c1"># [OPT, DEF=2] Maximum order of the BDF method in CVODE</span>
</pre></div>
</div>
<p>Note that the last four parameters belong to the Reactor class of PelePhysics but are specified here for completeness. In particular, CVODE is the adequate choice of integrator to tackle PeleLMeX large time step sizes. Several linear solvers are available depending on whether or not GPU are employed: on CPU, <cite>dense_direct</cite> is a finite-difference direct solver, <cite>denseAJ_direct</cite> is an analytical-jacobian direct solver (preferred choice), <cite>sparse_direct</cite> is an analytical-jacobian sparse direct solver based on the KLU library and <cite>GMRES</cite> is a matrix-free iterative solver; on GPU <cite>GMRES</cite> is a matrix-free iterative solver (available on all the platforms), <cite>sparse_direct</cite> is a batched block-sparse direct solve based on NVIDIA’s cuSparse (only with CUDA), <cite>magma_direct</cite> is a batched block-dense direct solve based on the MAGMA library (available with CUDA and HIP.</p>
</section>
<section id="embedded-geometry">
<h2>Embedded Geometry<a class="headerlink" href="#embedded-geometry" title="Link to this heading"></a></h2>
<p><cite>PeleLMeX</cite> geometry relies on AMReX implementation of the EB method. Simple geometrical objects
can thus be constructed using <a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/EB.html">AMReX internal parser</a>.
For instance, setting up a sphere of radius 5 mm can be achieved:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">eb2</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">=</span> <span class="n">sphere</span>
<span class="n">eb2</span><span class="o">.</span><span class="n">sphere_radius</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">eb2</span><span class="o">.</span><span class="n">sphere_center</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">eb2</span><span class="o">.</span><span class="n">sphere_has_fluid_inside</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">eb2</span><span class="o">.</span><span class="n">small_volfrac</span> <span class="o">=</span> <span class="mf">1.0e-4</span>
<span class="n">eb2</span><span class="o">.</span><span class="n">maxiter</span> <span class="o">=</span> <span class="mi">200</span>
</pre></div>
</div>
<p>The <cite>eb2.small_volfrac</cite> controls volume fraction that are deemed too small and eliminated from the EB representation.
This operation is done iteratively and the maximum number of iteration is prescribed by <cite>eb2.maxiter</cite>.
For most applications, a single AMReX object is insufficient to represent the geometry. AMReX enable to combine
objects using constructive solid geometry (CSG) in order to create complex geometry. It is up to users to define
the combination of basic elements leading to their desired geometry. To switch to a user-defined EB definition, one
must set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">eb2</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">=</span> <span class="n">UserDefined</span>
</pre></div>
</div>
<p>and then implement the actual geometry definition in a <cite>EBUserDefined.H</cite> file located in the run folder (and add
to the GNUmakefile using <cite>CEXE_headers += EBUserDefined.H</cite>). An example of such implementation is available in the
<code class="docutils literal notranslate"><span class="pre">Exec/Case/ChallengeProblem</span></code> folder. Example of more generic EB problems are also found in the <code class="docutils literal notranslate"><span class="pre">Exec/RegTest/EB_*</span></code>
folders.</p>
<p>In addition to the input keys presented above, a set of <cite>PeleLMeX</cite>-specific keys are available in order to control refinement at the EB:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peleLM</span><span class="o">.</span><span class="n">refine_EB_type</span> <span class="o">=</span> <span class="n">Static</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">refine_EB_max_level</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">refine_EB_buffer</span> <span class="o">=</span> <span class="mf">2.0</span>
</pre></div>
</div>
<p>By default, the EB is refined to the <cite>amr.max_level</cite>, which can lead to undesirably high number of cells
close to the EB when the physics of interest might be elsewhere. The above lines enable to limit the
EB-level to level 1 (must be below <cite>amr.max_level</cite>) and a derefinement strategy is adopted to ensure
that fine-grid patches do not cross the EB boundary. The last parameter set a safety margin to increase
how far the derefinement is applied in order to account for grid-patches diagonals and proper nesting constrains.
Note that the parameter do not ensure explicitly coarse-fine/EB crossings are avoided and the code will fail when this happens.</p>
<p>It is also possible to change the default adiabatic EB wall condition to an isothermal EB. To do so, one need to switch the following
flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peleLM</span><span class="o">.</span><span class="n">isothermal_EB</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>The user is now responsible for providing the wall temperature <em>on all the EB walls</em>, but adiabtic wall can still be specified.
Control over the local EB thermal boundary condition is provided through the <cite>setEBState</cite> and <cite>setEBType</cite> functions, also
defined in the <cite>EBUserDefined.H</cite> already used above to provide a user-defined EB geometry. Example of isothermal EBs are provided
in <code class="docutils literal notranslate"><span class="pre">Exec/RegTest/EB_BackwardStepFlame</span></code> and <code class="docutils literal notranslate"><span class="pre">Exec/RegTest/EB_FlowPastCylinder</span></code> tests.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that when using isothermal EB in combination with LES, the thermal diffusion coefficient employed to compute the EB boundary thermal flux only uses the molecular contribution.</p>
</div>
</section>
<section id="linear-solvers">
<h2>Linear solvers<a class="headerlink" href="#linear-solvers" title="Link to this heading"></a></h2>
<p>Linear solvers are a key component of PeleLMeX algorithm, separate controls are dedicated to the various solver (MAC projection, nodal projection, diffusion, …)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#-------------------------LINEAR SOLVERS-----------------------</span>
<span class="n">nodal_proj</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>                      <span class="c1"># [OPT, DEF=0] Verbose of the nodal projector</span>
<span class="n">nodal_proj</span><span class="o">.</span><span class="n">rtol</span> <span class="o">=</span> <span class="mf">1.0e-11</span>                   <span class="c1"># [OPT, DEF=1e-11] Relative tolerance of the nodal projection</span>
<span class="n">nodal_proj</span><span class="o">.</span><span class="n">atol</span> <span class="o">=</span> <span class="mf">1.0e-12</span>                   <span class="c1"># [OPT, DEF=1e-14] Absolute tolerance of the nodal projection</span>
<span class="n">nodal_proj</span><span class="o">.</span><span class="n">mg_max_coarsening_level</span> <span class="o">=</span> <span class="mi">5</span>      <span class="c1"># [OPT, DEF=100] Maximum number of MG levels (useful when using EB)</span>

<span class="n">mac_proj</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>                        <span class="c1"># [OPT, DEF=0] Verbose of the MAC projector</span>
<span class="n">mac_proj</span><span class="o">.</span><span class="n">rtol</span> <span class="o">=</span> <span class="mf">1.0e-11</span>                     <span class="c1"># [OPT, DEF=1e-11] Relative tolerance of the MAC projection</span>
<span class="n">mac_proj</span><span class="o">.</span><span class="n">atol</span> <span class="o">=</span> <span class="mf">1.0e-12</span>                     <span class="c1"># [OPT, DEF=1e-14] Absolute tolerance of the MAC projection</span>
<span class="n">mac_proj</span><span class="o">.</span><span class="n">mg_max_coarsening_level</span> <span class="o">=</span> <span class="mi">5</span>        <span class="c1"># [OPT, DEF=100] Maximum number of MG levels (useful when using EB)</span>

<span class="n">diffusion</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>                       <span class="c1"># [OPT, DEF=0] Verbose of the scalar diffusion solve</span>
<span class="n">diffusion</span><span class="o">.</span><span class="n">rtol</span> <span class="o">=</span> <span class="mf">1.0e-11</span>                    <span class="c1"># [OPT, DEF=1e-11] Relative tolerance of the scalar diffusion solve</span>
<span class="n">diffusion</span><span class="o">.</span><span class="n">atol</span> <span class="o">=</span> <span class="mf">1.0e-12</span>                    <span class="c1"># [OPT, DEF=1e-14] Absolute tolerance of the scalar diffusion solve</span>

<span class="n">tensor_diffusion</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>                <span class="c1"># [OPT, DEF=0] Verbose of the velocity tensor diffusion solve</span>
<span class="n">tensor_diffusion</span><span class="o">.</span><span class="n">rtol</span> <span class="o">=</span> <span class="mf">1.0e-11</span>             <span class="c1"># [OPT, DEF=1e-11] Relative tolerance of the velocity tensor diffusion solve</span>
<span class="n">tensor_diffusion</span><span class="o">.</span><span class="n">atol</span> <span class="o">=</span> <span class="mf">1.0e-12</span>             <span class="c1"># [OPT, DEF=1e-14] Absolute tolerance of the velocity tensor diffusion solve</span>
</pre></div>
</div>
</section>
<section id="active-control">
<h2>Active control<a class="headerlink" href="#active-control" title="Link to this heading"></a></h2>
<p><cite>PeleLMeX</cite> includes an active control mechanism to enable statistically steady simulations of flames
maintaining the flame at a fixed position in the domain. An example of this feature is provided in
the triple flame tutorial <a class="reference internal" href="Tutorials_TripleFlame.html"><span class="doc">A simple triple flame</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To enable active control, a <code class="docutils literal notranslate"><span class="pre">FlowControllerData</span> <span class="pre">FCData</span></code> object must be added to the problem <code class="docutils literal notranslate"><span class="pre">ProbParm</span></code>!</p>
</div>
<p>During the course of the simulation, the FlowControllerData is updated based on the flame position to allow
the user to set the inflow velocity. The following options are available when using active control:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#---------------------- AC CONTROL -------------------------------</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="mi">1</span>                     <span class="c1"># [OPT, DEF=0] Use AC ?</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">use_temp</span> <span class="o">=</span> <span class="mi">1</span>               <span class="c1"># [OPT, DEF=1] Default in fuel mass, rather use iso-T position ?</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="mf">1400.0</span>       <span class="c1"># [OPT, DEF=-1] Value of iso-T ?</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="mf">5.0e-4</span>               <span class="c1"># [OPT, DEF=0.0] Control tau (should ~ 10 dt)</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mf">0.01</span>              <span class="c1"># [OPT, DEF=0.0] Where is the flame held ?</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="mi">1</span>                      <span class="c1"># [OPT, DEF=0] verbose</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="mi">1</span>                 <span class="c1"># [OPT, DEF=2] Controller: 1 - Linear, 2 - Quadratic, 3 - Weighted quadratic</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">velMax</span> <span class="o">=</span> <span class="mf">2.0</span>               <span class="c1"># [OPT, DEF=-1.0] limit inlet velocity, only used when positive</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">changeMax</span> <span class="o">=</span> <span class="mf">0.1</span>            <span class="c1"># [OPT, DEF=1.0] limit inlet velocity changes (absolute m/s)</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">flow_dir</span>  <span class="o">=</span> <span class="mi">1</span>              <span class="c1"># [OPT, DEF=AMREX_SPACEDIM-1] flame main direction</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">AC_history</span>  <span class="o">=</span> <span class="n">AChist</span>       <span class="c1"># [OPT, DEF=AC_history] Control history file, read upon restart</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">npoints_average</span> <span class="o">=</span> <span class="mi">5</span>        <span class="c1"># [OPT, DEF=3] Number of previous steps using to estimate new velocity</span>
<span class="n">active_control</span><span class="o">.</span><span class="n">pseudo_gravity</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># [OPT, DEF=0] add density proportional force to compensate for the acceleration</span>
                                          <span class="c1">#           of the gas due to inlet velocity changes</span>
</pre></div>
</div>
</section>
<section id="run-time-diagnostics">
<h2>Run-time diagnostics<a class="headerlink" href="#run-time-diagnostics" title="Link to this heading"></a></h2>
<p><cite>PeleLMeX</cite> provides a few diagnostics to check you simulations while it is running as well as adding basic analysis ingredients.</p>
<p>It is often useful to have an estimate of integrated quantities (kinetic energy, heat release rate, ,..), state extremas
or other overall balance information to get a sense of the status and sanity of the simulation. To this end, it is possible
to activate <cite>temporal</cite> diagnostics performing these reductions at given intervals:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#-------------------------TEMPORALS---------------------------</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">do_temporals</span> <span class="o">=</span> <span class="mi">1</span>                     <span class="c1"># [OPT, DEF=0] Activate temporal diagnostics</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">temporal_int</span> <span class="o">=</span> <span class="mi">10</span>                    <span class="c1"># [OPT, DEF=5] Temporal freq.</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">do_extremas</span> <span class="o">=</span> <span class="mi">1</span>                      <span class="c1"># [OPT, DEF=0] Trigger extremas, if temporals activated</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">do_mass_balance</span> <span class="o">=</span> <span class="mi">1</span>                  <span class="c1"># [OPT, DEF=0] Compute mass balance, if temporals activated</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">do_species_balance</span> <span class="o">=</span> <span class="mi">1</span>               <span class="c1"># [OPT, DEF=0] Compute species mass balance, if temporals activated</span>
</pre></div>
</div>
<p>The <cite>do_temporal</cite> flag will trigger the creation of a <cite>temporals</cite> folder in your run directory and the following entries
will be appended to an ASCII <cite>temporals/tempState</cite> file: step, time, dt, kin. energy integral, enstrophy integral, mean pressure
, fuel consumption rate integral, heat release rate integral. Additionally, if the <cite>do_temporal</cite> flag is activated, one can
turn on state extremas (stored in <cite>temporals/tempExtremas</cite> as min/max for each state entry), mass balance (stored in
<cite>temporals/tempMass</cite>) computing the total mass, dMdt and advective mass fluxes across the domain boundaries as well as the error in
the balance (dMdt - sum of fluxes), and species balance (stored in <cite>temporals/tempSpec</cite>) computing each species total mass, dM_Ydt,
advective &amp; diffusive fluxes across the domain boundaries, consumption rate integral and the error (dMdt - sum of fluxes - reaction).</p>
<p>Combustion diagnostics often involve the use of a mixture fraction and/or a progress variable, both of which can be defined
at run time and added to the derived variables included in the plotfile. If <cite>mixture_fraction</cite> or <cite>progress_variable</cite> is
added to the <cite>amr.derive_plot_vars</cite> list, one need to provide input for defining those. The mixture fraction is based on
Bilger’s element definition and one needs to provide the composition of the ‘fuel’ and ‘oxidizer’ tanks using a Cantera-like
format (&lt;species&gt;:&lt;value&gt;) which assumes unspecified species at zero, or a list of floats, in which case all the species must
be specified in the order they appear in the mechanism file.
The progress variable definition in based on a linear combination of the species mass fractions and temperature, and can be
specified in a manner similar to the mixture fraction, providing a list of weights and the prescription of a ‘cold’ and ‘hot’
state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------------------- INPUTS DERIVED DIAGS ------------------</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">fuel_name</span> <span class="o">=</span> <span class="n">CH4</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">mixtureFraction</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">Cantera</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">mixtureFraction</span><span class="o">.</span><span class="n">type</span>   <span class="o">=</span> <span class="n">mass</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">mixtureFraction</span><span class="o">.</span><span class="n">oxidTank</span> <span class="o">=</span> <span class="n">O2</span><span class="p">:</span><span class="mf">0.233</span> <span class="n">N2</span><span class="p">:</span><span class="mf">0.767</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">mixtureFraction</span><span class="o">.</span><span class="n">fuelTank</span> <span class="o">=</span> <span class="n">H2</span><span class="p">:</span><span class="mf">0.5</span> <span class="n">CH4</span><span class="p">:</span><span class="mf">0.5</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">progressVariable</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">Cantera</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">progressVariable</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">CO</span><span class="p">:</span><span class="mf">1.0</span> <span class="n">CO2</span><span class="p">:</span><span class="mf">1.0</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">progressVariable</span><span class="o">.</span><span class="n">coldState</span> <span class="o">=</span> <span class="n">CO</span><span class="p">:</span><span class="mf">0.0</span> <span class="n">CO2</span><span class="p">:</span><span class="mf">0.0</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">progressVariable</span><span class="o">.</span><span class="n">hotState</span> <span class="o">=</span> <span class="n">CO</span><span class="p">:</span><span class="mf">0.000002</span> <span class="n">CO2</span><span class="p">:</span><span class="mf">0.0666</span>
</pre></div>
</div>
<p>Analysing the data a-posteriori can become extremely cumbersome when dealing with extreme datasets.
PeleLMeX offers a set of diagnostics available at runtime and more are under development.
Currently, the list of diagnostic contains:</p>
<ul class="simple">
<li><p><cite>DiagFramePlane</cite> : extract a plane aligned in the ‘x’,’y’ or ‘z’ direction across the AMR hierarchy, writing
a 2D plotfile compatible with Amrvis, Paraview or yt. Only available for 3D simulations.</p></li>
<li><p><cite>DiagPDF</cite> : extract the PDF of a given variable and write it to an ASCII file.</p></li>
<li><p><cite>DiagConditional</cite> : extract statistics (average and standard deviation, integral or sum) of a
set of variables conditioned on the value of given variable and write it to an ASCII file.</p></li>
</ul>
<p>When using <cite>DiagPDF</cite> or <cite>DiagConditional</cite>, it is possible to narrow down the diagnostic to a region of interest
by specifying a set of filters, defining a range of interest for a variable. Note also the for these two diagnostics,
fine-covered regions are masked. The following provide examples for each diagnostic:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#--------------------------DIAGNOSTICS------------------------</span>

<span class="n">peleLM</span><span class="o">.</span><span class="n">diagnostics</span> <span class="o">=</span> <span class="n">xnormP</span> <span class="n">condT</span> <span class="n">pdfTest</span>

<span class="n">peleLM</span><span class="o">.</span><span class="n">xnormP</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DiagFramePlane</span>                             <span class="c1"># Diagnostic type</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">xnormP</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">xNorm5mm</span>                                   <span class="c1"># Output file prefix</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">xnormP</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="mi">0</span>                                        <span class="c1"># Plane normal (0, 1 or 2 for x, y or z)</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">xnormP</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="mf">0.005</span>                                    <span class="c1"># Coordinate in the normal direction</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">xnormP</span><span class="o">.</span><span class="n">int</span>    <span class="o">=</span> <span class="mi">5</span>                                        <span class="c1"># Frequency (as step #) for performing the diagnostic</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">xnormP</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">Linear</span>                            <span class="c1"># [OPT, DEF=Linear] Interpolation type : Linear or Quadratic</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">xnormP</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="n">x_velocity</span> <span class="n">mag_vort</span> <span class="n">density</span>         <span class="c1"># List of variables outputted to the 2D pltfile</span>

<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DiagConditional</span>                             <span class="c1"># Diagnostic type</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">condTest</span>                                    <span class="c1"># Output file prefix</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">int</span>  <span class="o">=</span> <span class="mi">5</span>                                           <span class="c1"># Frequency (as step #) for performing the diagnostic</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">xHigh</span> <span class="n">stoich</span>                             <span class="c1"># [OPT, DEF=None] List of filters</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">xHigh</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">x</span>                               <span class="c1"># Filter field</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">xHigh</span><span class="o">.</span><span class="n">value_greater</span> <span class="o">=</span> <span class="mf">0.006</span>                        <span class="c1"># Filter definition : value_greater, value_less, value_inrange</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">stoich</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">mixture_fraction</span>               <span class="c1"># Filter field</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">stoich</span><span class="o">.</span><span class="n">value_inrange</span> <span class="o">=</span> <span class="mf">0.053</span> <span class="mf">0.055</span>                 <span class="c1"># Filter definition : value_greater, value_less, value_inrange</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">conditional_type</span> <span class="o">=</span> <span class="n">Average</span>                         <span class="c1"># Conditional type : Average, Integral or Sum</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">nBins</span> <span class="o">=</span> <span class="mi">50</span>                                         <span class="c1"># Number of bins for the conditioning variable</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">condition_field_name</span> <span class="o">=</span> <span class="n">temp</span>                        <span class="c1"># Conditioning variable name</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">condT</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="n">HeatRelease</span> <span class="n">I_R</span><span class="p">(</span><span class="n">CH4</span><span class="p">)</span> <span class="n">I_R</span><span class="p">(</span><span class="n">H2</span><span class="p">)</span>         <span class="c1"># List of variables to be treated</span>

<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DiagPDF</span>                                   <span class="c1"># Diagnostic type</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">PDFTest</span>                                   <span class="c1"># Output file prefix</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">int</span>  <span class="o">=</span> <span class="mi">5</span>                                         <span class="c1"># Frequency (as step #) for performing the diagnostic</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">innerFlame</span>                             <span class="c1"># [OPT, DEF=None] List of filters</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">innerFlame</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">temp</span>                     <span class="c1"># Filter field</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">innerFlame</span><span class="o">.</span><span class="n">value_inrange</span> <span class="o">=</span> <span class="mf">450.0</span> <span class="mf">1500.0</span>          <span class="c1"># Filter definition : value_greater, value_less, value_inrange</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">nBins</span> <span class="o">=</span> <span class="mi">50</span>                                       <span class="c1"># Number of bins for the PDF</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">normalized</span> <span class="o">=</span> <span class="mi">1</span>                                   <span class="c1"># [OPT, DEF=1] PDF is normalized (i.e. integral is unity) ?</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">volume_weighted</span> <span class="o">=</span> <span class="mi">1</span>                              <span class="c1"># [OPT, DEF=1] Computation of the PDF is volume weighted ?</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="mf">2.0</span>                                  <span class="c1"># [OPT, DEF=data min/max] Specify the range of the PDF</span>
<span class="n">peleLM</span><span class="o">.</span><span class="n">pdfTest</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">x_velocity</span>                          <span class="c1"># Variable of interest</span>
</pre></div>
</div>
</section>
<section id="run-time-control">
<h2>Run-time control<a class="headerlink" href="#run-time-control" title="Link to this heading"></a></h2>
<p>Following some of AMReX’s AmrLevel class implementation, PeleLMeX provides a couple of triggers to interact with the code while
it is running. This can be done by adding an empty file to the folder where the simulation is currently running using for
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">plt_and_continue</span>
</pre></div>
</div>
<p>The list of available triggers is:</p>
<table class="docutils align-default" id="id2">
<caption><span class="caption-number">Table 8 </span><span class="caption-text">PeleLMeX run-time triggers</span><a class="headerlink" href="#id2" title="Link to this table"></a></caption>
<colgroup>
<col style="width: 33.3%" />
<col style="width: 66.7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Function</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>plt_and_continue</p></td>
<td><p>Write a pltfile to disk and pursue the simulation</p></td>
</tr>
<tr class="row-odd"><td><p>chk_and_continue</p></td>
<td><p>Write a chkfile to disk and pursue the simulation</p></td>
</tr>
<tr class="row-even"><td><p>dump_and_stop</p></td>
<td><p>Write both pltfile and chkfile to disk and stop the simulation</p></td>
</tr>
</tbody>
</table>
<p>By default, the code checks if these files exist every 10 time steps, but the user can either increase or decrease the
frequency using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">amr</span><span class="o">.</span><span class="n">message_int</span>      <span class="o">=</span> <span class="mi">20</span>                <span class="c1"># [OPT, DEF=10] Frequency for checking the presence of trigger files</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Performances.html" class="btn btn-neutral float-left" title="Performances" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Troubleshooting.html" class="btn btn-neutral float-right" title="Troubleshooting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2022, PeleTeam.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>